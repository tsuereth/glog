name: UpdateDataAndBuildAndDeploy

on:
  workflow_dispatch:
  push:
    branches:
      - main
  # Run on a schedule to keep data updated even if there's no new content.
  schedule:
    - cron: '0 12 * * 5'

jobs:
  UpdateDataAndBuildAndDeploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: SetupDotNet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 6.0.x

      - name: TestGlogGenerator
        run: |
          dotnet test GlogGenerator.Test/GlogGenerator.Test.csproj

      - name: BuildGlogGenerator
        run: |
          rm -rf GlogGeneratorBuild
          dotnet build GlogGenerator/GlogGenerator.csproj --configuration Release --output GlogGeneratorBuild

      - name: UpdateDataAndBuildStaticSite
        env:
          TWITCH_CLIENT_SECRET: ${{ secrets.TWITCH_CLIENT_SECRET }}
        run: |
          rm -rf public
          ./GlogGeneratorBuild/GlogGenerator build -i . -t GlogGeneratorBuild/templates -u true --igdb-client-id jy5t8x2w2eqdc7bax2zx3rlne7eup4 --igdb-client-secret $TWITCH_CLIENT_SECRET -h "https://tsuereth.com" -o public

      # TODO: Reimplement to allow multiple files, if source data has changed!
      - name: CommitDataUpdates
        env:
          BRANCH: ${{ github.head_ref || github.ref }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! git diff --quiet igdb_cache.json ; then \
            gh api --method PUT /repos/:owner/:repo/contents/igdb_cache.json \
              --field branch="$BRANCH" \
              --field encoding="base64" \
              --field content=@<(base64 -i igdb_cache.json) \
              --field sha="$(git rev-parse $BRANCH:igdb_cache.json)" \
              --field message="[skip ci] Automatically-updated game data." ; \
            fi

      - name: Deploy
        env:
          DEPLOY_GLOG_PRIVATE_KEY: ${{ secrets.DEPLOY_GLOG_PRIVATE_KEY }}
        run: |
          echo "$DEPLOY_GLOG_PRIVATE_KEY" > deploy-glog_id_rsa
          chmod 0600 deploy-glog_id_rsa
          rsync -vrtL --checksum --omit-dir-times --cvs-exclude --delete \
            -e "ssh -p 31771 -i deploy-glog_id_rsa -o StrictHostKeyChecking=no" \
            public/* \
            "deploy-glog@tsuereth.com:/var/www/tsuereth_web/glog/"

      - name: Cleanup
        if: ${{ always() }}
        run: |
          rm -f deploy-glog_id_rsa

